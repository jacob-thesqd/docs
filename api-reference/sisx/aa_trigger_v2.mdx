---
title: 'AA Trigger V2'
description: 'This n8n workflow is designed to automatically assign tasks based on certain conditions. It triggers via webhooks, processes incoming task data, checks for non-design employee assignees, interacts with a Supabase database to retrieve task statistics, and logs execution data. Depending on task conditions, it may trigger a helper workflow or queue tasks for later processing.'
api: "POST /aa-trigger"
---

## Workflow Details

- **Workflow ID**: `EjB61qIn4LHevKgc`
- **Server**: sisx.thesqd.com
- **Status**: Active
- **Created**: May 6, 2025
- **Last Updated**: June 10, 2025

## Webhook Endpoints

```
POST https://sisx.thesqd.com/webhook/aa-trigger
POST https://sisx.thesqd.com/webhook/aa-trigger-retry
```

## Workflow Process

### 1. Webhook
- **Path**: `/aa-trigger`
- **Method**: POST
- **Purpose**: This is the primary webhook trigger for the workflow, receiving incoming task data. It captures the raw request body and logs execution data related to task ID.

### 2. Webhook1
- **Path**: `/aa-trigger-retry`
- **Method**: POST
- **Purpose**: This webhook is likely used for retry mechanisms or alternative triggering events, capturing specific request data.

### 3. Edit Fields
- **Purpose**: Prepares the incoming webhook data by wrapping the `body` in an array, making it consistent for downstream processing.
- **Parameters**:
  - `body`: `={{ [$json.body] }}`

### 4. Execution Data
- **Purpose**: Logs specific data from the webhook trigger, including the `task_id` and the raw `body` of the incoming request. This is useful for debugging and tracking.
- **Parameters**:
  - `taskId`: `={{ $json.body[0].task_id }}`

### 5. Remove Duplicates1
- **Purpose**: Removes duplicate entries based on the `task_id` to ensure that each task is processed only once within a given execution.
- **Parameters**:
  - `dedupeValue`: `={{ $json.body[0].task_id }}`

### 6. 48 Hours or Sooner
- **Purpose**: Filters tasks to only include those created within the last 48 hours or those that meet a specific date condition.
- **Parameters**:
  - `conditions`:
    - `leftValue`: `={{ $json.body[0].row_created.toDateTime() }}`
    - `operator`: `afterOrEquals`
    - `rightValue`: `={{ $now.minus(48,'hour') }}`

### 7. Postgres3
- **Purpose**: Selects data from the `aa_log` table in PostgreSQL, specifically looking for entries related to the current `account` with a `status` of 'triggered'. This is likely to check if a task for this account has already been processed or triggered.
- **Parameters**:
  - `operation`: `select`
  - `table`: `aa_log`
  - `where`:
    - `account`: `={{ $json.body[0].account }}`
    - `status`: `triggered`
  - `limit`: `1`
  - `schema`: `public`

### 8. If
- **Purpose**: This node acts as a conditional check. It evaluates if the keys returned from the `Postgres3` node are not empty, determining the next path in the workflow.
- **Parameters**:
  - `conditions`:
    - `operator`: `notEmpty`
    - `rightValue`: ``
    - `leftValue`: `={{ $json.keys() }}`

### 9. Wait
- **Purpose**: Introduces a delay of 45 seconds. This might be to allow for other processes to complete or to avoid overwhelming downstream systems.

### 10. Merge3
- **Purpose**: This merge node combines data from two branches of the workflow. It uses `useDataOfInput: 2` which suggests it prioritizes data from the second input.

### 11. 10 Standard Delay
- **Purpose**: Introduces a delay of 10 seconds.

### 12. Supabase
- **Purpose**: Fetches task statistics from a Supabase database using a stored procedure `rpc/get_account_task_stats`, filtering by `account_id_param` from the incoming webhook data.
- **Parameters**:
  - `operation`: `getAll`
  - `tableId`: `rpc/get_account_task_stats`
  - `returnAll`: `true`
  - `filterString`: `={{ $json.body[0].account }}`

### 13. Execution Data2
- **Purpose**: Logs data related to the Supabase node execution, specifically capturing the `account` and `room` from the input and storing it.
- **Parameters**:
  - `account`: `={{ $json.account }}`
  - `room`: `={{ $json.room }}`

### 14. Edit Fields1
- **Purpose**: Modifies the fields for the next step, likely preparing data for a merge operation.
- **Parameters**:
  - `status`: `={{ $json.room > 0 ? 'triggered' : 'queued' }}`
  - `queue_num`: `={{ $json.room && $json.room > 0 ? null : ($json.aa_queued_count ? $json.aa_queued_count + 1 : null) }}`
  - `account`: `={{ $json.account || $('48 Hours or Sooner').item.json.body[0].account }}`

### 15. Merge2
- **Purpose**: This merge node is used to branch the workflow based on conditions.

### 16. Check For Non-Design Employee Assignees
- **Purpose**: This node queries a PostgreSQL database to find current assignees for a given `task_id` and checks if any of them belong to departments other than 'design squad' or 'video squad'.
- **Parameters**:
  - `operation`: `executeQuery`
  - `query`:
    ```sql
    WITH current_assignees AS (
      SELECT DISTINCT ah.task_id, ah.assignee
      FROM assignee_history ah
      WHERE NOT EXISTS (
        SELECT 1
        FROM assignee_history ah2
        WHERE ah2.task_id = ah.task_id
        AND ah2.assignee = ah.assignee
        AND ah2.change_type = 'assignee_rem'
        AND ah2.changed_at > ah.changed_at
      )
      AND ah.change_type = 'assignee_add'
    )
    SELECT
      ca.task_id,
      e.name,
      cu.email,
      LOWER(e.department) as department
    FROM current_assignees ca
    JOIN clickup_users cu ON cu.clickup_id = ca.assignee
    LEFT JOIN employees e ON e.email = cu.email
    WHERE ca.task_id = '{{ $json.body[0].task_id }}'
    AND e.department IS NOT NULL
    AND LOWER(e.department) != 'design squad'
    AND LOWER(e.department) != 'video squad'
    ORDER BY cu.email;
    ```
  - `credentials`: `postgres` with ID `0lnPA6CM1rsnpGZQ` (SquadData - N. Cal Replica)

### 17. Merge
- **Purpose**: Combines data from multiple sources, likely the initial webhook data and the results from the Supabase node. It prioritizes data from the first input in case of conflicts.
- **Parameters**:
  - `mode`: `combine`
  - `clashHandling`: `preferInput1`
  - `combineBy`: `combineByPosition`

### 18. Execution Data1
- **Purpose**: Logs the result of the check for non-design assignees. It records whether the condition (no non-design assignees or a successful check) is met.
- **Parameters**:
  - `pass`: `={{ $('Check For Non-Design Employee Assignees').all().map(i=>i.json.department).length == 0 || $('Check For Non-Design Employee Assignees').first().json.success ? 'true' : 'false' }}`

### 19. Edit Fields2
- **Purpose**: Prepares data for the next step, determining if there are any non-design assignees and including the Supabase node's output.
- **Parameters**:
  - `no_non_design_assignees`: `={{ $('Check For Non-Design Employee Assignees').all().map(i=>i.json.department).length == 0 || $('Check For Non-Design Employee Assignees').first().json.success ? true : false }}`
  - `supabase_node`: `={{ $('Supabase').first().json }}`

### 20. Execute Workflow
- **Purpose**: This node executes another n8n workflow, likely a helper workflow that performs subsequent actions based on the processed data.
- **Parameters**:
  - `workflowId`: `68SJpwgdeeFpIh7z` (AA Trigger Helper)
  - `workflowInputs`: An empty object, suggesting the helper workflow will use context from the current execution or fetch its own data.

### 21. Format Body
- **Purpose**: This node appears to be a cleanup step, taking the raw JSON body from the webhook and removing a specific field (`unassigned`). It also ensures specific keys like `workflow_id` and `execution_id` are included.
- **Parameters**:
  - `mode`: `raw`
  - `include`: `selected`
  - `jsonOutput`: `={{ [$json.body].flat()[0].removeField("unassigned") }}`
  - `includeFields`: `workflow_id, execution_id, status`
  - `includeOtherFields`: `true`

### 22. Add Necessary Keys
- **Purpose**: Adds essential keys to the data, such as the `workflow_id`, `execution_id`, and sets the `status` to 'triggered'.
- **Parameters**:
  - `=workflow_id`: `={{ $workflow.id }}`
  - `=execution_id`: `={{ $execution.id }}`
  - `status`: `triggered`

### 23. Execution Data3
- **Purpose**: Saves execution data related to task assignment status.

## Data Flow

Webhook Trigger (`Webhook` or `Webhook1`) → Edit Fields → Remove Duplicates1 → 48 Hours or Sooner → Postgres3 → If → Wait → Merge3 → 10 Standard Delay → Supabase → Execution Data2 → Edit Fields1 → Merge2 → Check For Non-Design Employee Assignees → Merge → Execution Data1 → Edit Fields2 → Execute Workflow (Helper Workflow)

*Note: There are multiple branches and merge points, indicating conditional processing and data aggregation.*

## Error Handling

- **Continue on Error**: Enabled for `Check For Non-Design Employee Assignees`, `Edit Fields1`, `Postgres3`. This means the workflow will attempt to continue even if these nodes encounter errors.

## Authentication

### Postgres
- **Credential ID**: `0lnPA6CM1rsnpGZQ`
- **Name**: SquadData - N. Cal Replica

### Supabase
- **Credential ID**: `NifWy1sih0M2biEc`
- **Name**: Squad Data