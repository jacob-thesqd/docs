---
title: "MMQ (Webhook - PATCH)"
description: "This API endpoint is triggered by a PATCH request sent via a webhook when a specific event occurs. It processes the incoming data, interacts with Postgres to retrieve and update task-related information in the database, updates task statuses in ClickUp, and manages queue and scheduling data based on the request parameters. The workflow handles different task states such as play, pause, and update, ensuring synchronization across systems."
api: "PATCH /mmq"
---

## Workflow Overview

This endpoint is triggered by PATCH requests to `/mmq`. It initiates a sequence of actions primarily focused on managing task statuses and scheduling. The webhook activates nodes that query the database for task details, check resource availability, update task statuses in ClickUp, and modify database entries related to task queues. The process includes conditional logic to handle different actions like playing or pausing tasks, updating task attributes, and managing queue positions.

---

## Request Example

<RequestExample>

```bash Request
curl --request PATCH \
  --url https://sisx.thesqd.com/webhook/mmq
```

</RequestExample>

---

## Webhook Trigger

### Webhook

Listens for PATCH or GET requests at the path `/mmq`. Response mode is set to process with a response node, and it can accept multiple methods.

- **Path:** `mmq`
- **Methods:** `GET`, `PATCH`
- **Response Mode:** `responseNode`
- **Multiple Methods:** `true`

---

## Nodes

### Sticky Note ("# Logo")

Provides a visual header with content "Logo" for organizational purposes. No parameters to document.

---

### Postgres5

Queries ClickUp folder and list associations for a specific task ID provided in the request query (`$json.query.id`). This retrieves the folders and lists related to the task for further processing.

- **Query:**
```sql
SELECT
cf.name,
cf.account
FROM public.clickup_folders cf
JOIN public.clickup_lists cl on cl.folder = cf.id
JOIN public.tasks t ON t.list_id = cl.id
WHERE t.task_id = '{{ $json.query.id }}'
```

- **Credentials:** `SquadData - N. Cal Replica`
- **Operation:** `executeQuery`
- **Type:** PostgreSQL

---

### Switch2

Contains rules based on presence of `id` and `account` query parameters in the incoming request, determining whether the request contains a task ID or an account.

- **Rules:**
  - If `id` exists and `account` is absent, follow output for task handling.
  - If `account` exists and `id` is absent, follow account handling.

- **Options:** `fallbackOutput: "extra"`

---

### Get Account1

Sets the account object in the data to enable account-specific processing, extracting `account` from the query string.

- **Assignment:**
```json
{"account": "{{ $json.query.account }}"}
```

- **Operation:** `set`

---

### Postgres7

Performs a complex query to retrieve task details and associated metadata for a specific account, including current task statuses, tags, assignees, due dates, and other contextual data, joining various historical tables for latest records.

- **Query:**
(See detailed extended SQL in input for full query; it includes latest status, due date, time estimates, tags, and assignment info.)

- **Credentials:** `SquadData`
- **Operation:** `executeQuery`

---

### ClickUp1

Reverts the status of a task in ClickUp to its previous state based on stored history, particularly for tasks associated with the given task ID.

- **Fields to update:**
```json
{
  "status": "{{ $json.status_before }}",
  "dueDate": "{{ $json.due_date_after.toDateTime().set({hour:18}) }}"
}
```

- **Credentials:** `TheSquad API`
- **Operation:** `update`

---

### Edit Fields12

Updates task-specific fields such as task ID, status, active flag, and due date based on contextually gathered data about the task.

- **Assignment:**
```json
{
  "task_id": "{{ $json.id }}",
  "status": "{{ $json.status.status }}",
  "active": true,
  "due_date": "{{ $json.due_date.toDateTime('ms').format('yyyy-MM-dd') }}"
}
```

- **Operation:** `set`

---

### Postgres13

Inserts or updates task log entries with detailed task and queue data, including the action (`play`, `pause`, etc.), task data, and account info.

- **Columns:**
  - `data`: serialized JSON of task and action data.
  - `action`: e.g., `"play"` or `"pause"`
  - `account`: derived from context.

- **Operation:** `update`

- **Credentials:** `SquadData`

---

### Sticky Note ("# App Data")

Serves as a visual separator for organization in the workflow. No parameters.

---

### Switch5

Determines whether the incoming request action is `"pause"` or `"play"` by comparing `body.action`.

- **Rules:**
  - If `action` equals `"pause"`, output branch for pausing.
  - If `action` equals `"play"`, output branch for playing.

- **Options:** Default branch selection.

---

### Edit Fields9

Sets task ID, status (`"on hold"`), and active flag (`false`) for pausing a task.

- **Assignment:**
```json
{
  "task_id": "{{ $json.id }}",
  "status": "on hold",
  "active": false
}
```

- **Operation:** `set`

---

### Postgres11

Creates or updates latest status history for a task in the `status_history` table, capturing the change to `"on hold"`.

- **Query:**
(Insert or update status history for task with `task_id`).

- **Credentials:** `SquadData`

---

### Webhook3

Receives a PATCH request from an external system to update task status to `"playing"` or `"paused"` via queries, with specific details in request body.

- **Path:** `play-pause`
- **Method:** `PATCH`
- **Response Mode:** `responseNode`

---

### Webhook4

Receives another webhook to process further task updates or triggers; response mode is `respondWith binary`.

---

### Edit Fields5

Prepares batch updates on tasks and schedule info, including the list of tasks, capacity, or scheduling parameters, based on prior database query results.

- **Assignment:**
```json
{
  "cap": 7,
  "tasks": [ ... task list ... ],
  "account": "{{ $json.account }}"
}
```

- **Operation:** `set`

---

### Postgres15

Logs actions related to pausing tasks, updating the queue position and status in the database.

- **Columns:**
```json
{
  "data": "{{ $json.toJsonString() }}",
  "action": "pause",
  "account": "{{ $json.folder.name.match(/\\d+/)[0] }}"
}
```

- **Credentials:** `SquadData`
- **Operation:** `execute`

---

### Webhook6

Responds to a webhook with status message indicating if tasks were found or not.

- **Response Body:**
```json
{
  "tasks_found": false
}
```

---

### Merge10 & Set (Webhooks)

Handle conditional branching for updating task status, with separate logic for different webhook responses or data inputs.

---

### Postgres12

Logs task data updates using batch or individual operations; currently disabled.

---

### Check if account has room

Queries resource availability and current task capacity, including overall account limits, task counts, and scheduling.

- **Query:**
```sql
SELECT * FROM get_account_task_stats({{ $json.account }})
JOIN accounts a ON a.account = {{ $json.account }}
```

- **Credentials:** `SquadData`
- **Operation:** `executeQuery`

---

## Execution Data Highlights

The execution data indicates successful processing through key nodes:

- **Handling incoming webhook data**
- **Updating task status in ClickUp**
- **Inserting logs into Postgres**
- **Updating task details and scheduling**
- **Conditional routing based on action ("play" or "pause")**
- **Final webhook response with tasks_found = false**

---

## Pin Data

Contains the current state and context of the webhook payload, including headers, body content, and URL, used for reference during processing. For example:

```json
{
  "body": {},
  "query": {"id": "86dwqhyux"},
  "headers": {...},
  "webhookUrl": "https://sisx.thesqd.com/webhook/mmq"
}
```