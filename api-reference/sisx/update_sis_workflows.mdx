---
title: 'Update Sis_Workflows'
description: 'This N8N workflow synchronizes n8n workflow data with a PostgreSQL database. It is triggered by a webhook when a new workflow is created and also has a scheduled trigger for periodic updates and deletions. The workflow fetches workflow details, maps them to database columns, and upserts or deletes records in the `sis_workflows` table.'
api: "POST /sis-sync-wf-new-record, POST /sis-sync-wf-delete, POST /sis-sync-wf-cursor"
---

## Workflow Details

- **Workflow ID**: `1qwOAnekFS2LxnSx`
- **Status**: Active
- **Created**: April 9, 2025
- **Last Updated**: April 9, 2025

## Webhook Endpoints

- `POST /sis-sync-wf-new-record`
- `POST /sis-sync-wf-delete`
- `POST /sis-sync-wf-cursor`

## Workflow Process

### 1. Schedule Trigger
- **Type**: Schedule Trigger
- **Purpose**: Initiates the workflow on a schedule.
- **Parameters**:
  - `triggerAtHour`: 20
  - `triggerAtMinute`: 5

### 2. Fields
- **Type**: Set Node
- **Purpose**: Defines variables for cursor and server details.
- **Parameters**:
  - `cursor`: `={{ $json.body.cursor ? '&cursor=' + $json.body.cursor : '' }}`
  - `server`: `sisx.thesqd.com`

### 3. All Workflows
- **Type**: HTTP Request
- **Purpose**: Fetches all workflows from the n8n API, including pagination cursor.
- **Parameters**:
  - `url`: `=https://{{ $json.server }}/api/v1/workflows?limit=200&excludePinnedData=true{{ $json.cursor }}`
  - `authentication`: Predefined Credential Type (`n8nApi`)

### 4. Split Out
- **Type**: Split Out
- **Purpose**: Splits the incoming data array into individual workflow items.
- **Parameters**:
  - `fieldToSplitOut`: `data`

### 5. Check Cursor
- **Type**: Filter
- **Purpose**: Checks if a `nextCursor` exists in the 'All Workflows' output to determine if pagination is needed.
- **Parameters**:
  - `combinator`: `and`
  - `conditions`:
    - `leftValue`: `={{ $('All Workflows').item.json.nextCursor ? $('All Workflows').item.json.nextCursor : '' }}`
    - `operator`: `notEmpty`

### 6. Check Webhook
- **Type**: Filter
- **Purpose**: Checks if the webhook has been executed.
- **Parameters**:
  - `combinator`: `and`
  - `conditions`:
    - `leftValue`: `={{ $('Cursor').isExecuted}}`
    - `operator`: `true`

### 7. Cursor Response
- **Type**: Respond to Webhook
- **Purpose**: Responds to the webhook for cursor-related actions.
- **Parameters**:
  - `respondWith`: `allIncomingItems`
  - `options`:
    - `responseCode`: `200`

### 8. New Record
- **Type**: Webhook Trigger
- **Path**: `sis-sync-wf-new-record`
- **Method**: `POST`
- **Response Mode**: `responseNode`
- **Purpose**: Receives notifications for new workflow records.

### 9. Workflow ID
- **Type**: Set Node
- **Purpose**: Extracts the `workflow_id` from the webhook request body.
- **Parameters**:
  - `assignments`:
    - `name`: `id`
    - `value`: `={{ $json.body.workflow_id }}`

### 10. Get Workflow
- **Type**: HTTP Request
- **Purpose**: Fetches details of a specific workflow using its ID.
- **Parameters**:
  - `url`: `=https://{{ $('Fields').item.json.server }}/api/v1/workflows/{{ $('Workflow ID').item.json.id }}`
  - `authentication`: Predefined Credential Type (`n8nApi`)

### 11. Wing
- **Type**: Code Node
- **Purpose**: Determines the 'wing' (e.g., 'SaRW', 'DW') based on workflow tags.
- **Parameters**:
  - `jsCode`:
    ```javascript
    function getMatchingTag(item) {
      const tags = item.json?.workflow?.tags || [];
      const tagNames = tags.map(tag => (tag?.name || tag || '').toLowerCase());

      if (tagNames.includes('sarw')) return { json: { matchedTag: 'SaRW' } };
      if (tagNames.includes('dw')) return { json: { matchedTag: 'DW' } };
      return { json: { matchedTag: null } };
    }

    return getMatchingTag($input.item);
    ```

### 12. Get Emp
- **Type**: PostgreSQL
- **Purpose**: Retrieves employee information from the `employees` table based on email.
- **Parameters**:
  - `operation`: `select`
  - `table`: `employees`
  - `schema`: `public`
  - `where`:
    - `column`: `email`
    - `value`: `={{ $('Get Workflow').item.json.shared[0].project.projectRelations[0].user.email }}`
  - `returnAll`: `true`
- **Credentials**: `SquadData`

### 13. Check if record exists
- **Type**: PostgreSQL
- **Purpose**: Checks if a workflow record already exists in the `sis_workflows` table based on server and workflow ID.
- **Parameters**:
  - `operation`: `select`
  - `table`: `sis_workflows`
  - `schema`: `public`
  - `where`:
    - `column`: `server`
    - `value`: `={{ $('Fields').item.json.server }}`
    - `column`: `id`
    - `value`: `={{ $('Split Out').item.json.id }}`
  - `options`:
    - `outputColumns`: `["id", "platform", "server", "last_udpated_at"]`
  - `returnAll`: `true`
  - `alwaysOutputData`: `true`
- **Credentials**: `SquadData`

### 14. Filter
- **Type**: Filter
- **Purpose**: Filters records based on whether they exist in the database.
- **Parameters**:
  - `combinator`: `and`
  - `conditions`:
    - `leftValue`: `={{ $('Fields').item.json.server }}`
    - `operator`: `exists`

### 15. If1
- **Type**: If Node
- **Purpose**: Checks if the workflow's `updatedAt` is after or equal to the last 7 days.
- **Parameters**:
  - `combinator`: `and`
  - `conditions`:
    - `leftValue`: `={{ $json.updatedAt }}`
    - `operator`: `afterOrEquals`

### 16. Get Workflow (for If1)
- **Type**: HTTP Request
- **Purpose**: Fetches details of a specific workflow using its ID.
- **Parameters**:
  - `url`: `=https://{{ $('Fields').item.json.server }}/api/v1/workflows/{{ $('Split Out').item.json.id }}`
  - `authentication`: Predefined Credential Type (`n8nApi`)

### 17. Upsert
- **Type**: PostgreSQL
- **Purpose**: Upserts workflow data into the `sis_workflows` table.
- **Parameters**:
  - `operation`: `upsert`
  - `table`: `=sis_workflows`
  - `schema`: `public`
  - `matchingColumns`: `["id"]`
  - `columns`:
    - `id`: `={{ $('Get Workflow').item.json.id }}`
    - `link`: `=https://{{ $('Fields').item.json.server }}/workflow/{{ $('Get Workflow').item.json.id }}`
    - `name`: `={{ $('Get Workflow').item.json.name }}`
    - `wing`: `={{ $('Wing').item.json.matchedTag }}`
    - `active`: `={{ $('Get Workflow').item.json.active }}`
    - `server`: `={{ $('Fields').item.json.server }}`
    - `platform`: `n8n`
    - `created_at`: `={{ $('Get Workflow').item.json.createdAt }}`
    - `owner_cu_id`: `={{ $('Get Emp').item.json.clickup_id }}`
    - `owner_email`: `={{ $('Get Emp').item.json.email }}`
    - `last_synced_at`: `={{ $now }}`
    - `last_udpated_at`: `={{ $now }}`
  - `schema`: (Detailed schema for the `sis_workflows` table)
- **Credentials**: `SquadData`

### 18. Check Trigger
- **Type**: Filter
- **Purpose**: Checks if the trigger for the new record webhook was an 'error'.
- **Parameters**:
  - `combinator`: `and`
  - `conditions`:
    - `leftValue`: `={{ $('New Record').isExecuted ? $('New Record').item.json.body.trigger : ''}}`
    - `operator`: `equals`
    - `rightValue`: `error`

### 19. New Record Response
- **Type**: Respond to Webhook
- **Purpose**: Sends a response to the 'New Record' webhook.
- **Parameters**:
  - `respondWith`: `allIncomingItems`
  - `options`:
    - `responseCode`: `200`

### 20. sis_workflows
- **Type**: PostgreSQL
- **Purpose**: Selects workflow records from `sis_workflows` that need to be checked for deletion, ordered by `last_synced_at` and `id`.
- **Parameters**:
  - `operation`: `select`
  - `table`: `=sis_workflows`
  - `schema`: `public`
  - `where`:
    - `column`: `server`
    - `value`: `sisx.thesqd.com`
  - `sort`:
    - `column`: `last_synced_at`
    - `direction`: `DESC`
    - `column`: `id`
  - `options`:
    - `outputColumns`: `["id", "platform", "server", "last_synced_at"]`
- **Credentials**: `SquadData`

### 21. Check last_synced_at
- **Type**: Filter
- **Purpose**: Filters workflows where `last_synced_at` is null or older than 1 day, indicating potential deletion.
- **Parameters**:
  - `combinator`: `or`
  - `conditions`:
    - `leftValue`: `={{ $json.last_synced_at == null }}`
    - `operator`: `true`
    - `leftValue`: `={{ new Date($json[\"last_synced_at\"]).toISOString().split(\"T\")[0] }}`
    - `operator`: `before`
    - `rightValue`: `={{ new Date(Date.now() - 86400000).toISOString().split('T')[0] }}`

### 22. Loop Over Items
- **Type**: Split in Batches
- **Purpose**: Loops over the filtered `sis_workflows` records to process potential deletions.
- **Parameters**:
  - `options`: {}

### 23. Trigger Delete Workflow Record
- **Type**: HTTP Request
- **Purpose**: Sends a request to a delete webhook endpoint.
- **Parameters**:
  - `url`: `https://sis2.thesqd.com/webhook/sis-sync-wf-delete`

### 24. n8n
- **Type**: n8n Node
- **Purpose**: Retrieves information about a specific workflow from the n8n instance.
- **Parameters**:
  - `operation`: `get`
  - `workflowId`: `={{ $json.id }}`
- **Credentials**: `n8nApi`

### 25. If
- **Type**: If Node
- **Purpose**: Checks if there was an error during the n8n node execution.
- **Parameters**:
  - `combinator`: `and`
  - `conditions`:
    - `leftValue`: `={{ $json.error }}`
    - `operator`: `exists`

### 26. Delete Record
- **Type**: PostgreSQL
- **Purpose**: Deletes a workflow record from the `sis_workflows` table if it was not found in the n8n API.
- **Parameters**:
  - `operation`: `deleteTable` (should be `delete`)
  - `deleteCommand`: `delete`
  - `table`: `=sis_workflows`
  - `schema`: `public`
  - `where`:
    - `column`: `id`
    - `value`: `={{ $('Loop Over Items').item.json.id }}`
- **Credentials**: `SquadData`

### 27. Update last_synced_at
- **Type**: PostgreSQL
- **Purpose**: Updates the `last_synced_at` timestamp for a workflow record in the `sis_workflows` table.
- **Parameters**:
  - `operation`: `update`
  - `table`: `=sis_workflows`
  - `schema`: `public`
  - `columns`:
    - `id`: `={{ $('Loop Over Items').item.json.id }}`
    - `last_synced_at`: `={{ new Date(Date.now()).toISOString().split('T')[0] }}`
  - `matchingColumns`: `["id"]`
- **Credentials**: `SquadData`

### 28. Sticky Note (UPSERTS WORKFLOW DATA TO DATABASE)
- **Type**: Sticky Note
- **Content**: `### UPSERTS WORKFLOW DATA TO DATABASE`
- **Context**: This sticky note refers to the overall process of updating workflow data in the database.

### 29. Sticky Note (REMOVES DELETED WORKFLOW FROM DATABASE)
- **Type**: Sticky Note
- **Content**: `### REMOVES DELETED WORKFLOW FROM DATABASE`
- **Context**: This sticky note refers to the process of identifying and removing deleted workflows from the database.

## Data Flow

`Schedule Trigger` -> `Fields` -> `All Workflows` -> `Split Out` -> `Check Cursor` / `Check Webhook` -> `Cursor Response` / `New Record`

`New Record` -> `Workflow ID` -> `Get Workflow` -> `Wing` -> `Get Emp` -> `Check if record exists` -> `Filter` -> `If1` -> `Upsert` / `Check Trigger` -> `New Record Response`

`Schedule Trigger` -> `sis_workflows` -> `Check last_synced_at` -> `Loop Over Items` -> `Trigger Delete Workflow Record` / `n8n` -> `If` -> `Delete Record` / `Update last_synced_at`

## Error Handling

- The `n8n` node has `onError: continueRegularOutput`, meaning if an error occurs during the retrieval of workflow data from n8n, the workflow will continue processing with available data.
- The `If` node checks for errors from the `n8n` node, and if an error is present, it proceeds to the `Delete Record` node.

## Authentication

- **n8n API**: Uses a predefined credential type named `n8n account` with ID `EA3jDaOurIeSxLKW`.
- **PostgreSQL**: Uses a predefined credential type named `SquadData` with ID `E1ZzQqtaKFgPZ75x`.