---
title: "MMQ (Webhook - PATCH)"
description: "This workflow handles incoming PATCH requests via a webhook endpoint /mmq, performs database queries to process account and task data, interacts with ClickUp to update task statuses, manages task states (such as play, pause), and maintains event logs. It orchestrates real-time task updates and status management for a queue system."
api: "PATCH /mmq"
---

## Request Example

<RequestExample>

```bash Request
curl --request POST \
  --url https://sisx.thesqd.com/webhook/mmq
```

</RequestExample>

---

## Workflow Overview

This workflow is triggered by PATCH requests to the `/mmq` endpoint, which is configured as a webhook. It performs a series of database lookups and updates, manages task statuses, and interacts with ClickUp to reflect task state changes such as play or pause. The workflow also handles real-time event logging, ensures task limits are adhered to, and responds with status information about the request processing. It incorporates multiple conditional branching to handle different task actions defined by incoming webhook payloads.

---

## Nodes

### Webhook (n8n-nodes-base.webhook)
This is the initial trigger node that listens for PATCH requests on the `/mmq` endpoint.

- Path: `mmq`
- Options: `{}` (no additional options)
- Response Mode: `responseNode`
- Multiple Methods Allowed: `true` (accepts GET, PATCH)
- Response Mode: Sends output to the response node for further processing

---

### Sticky Note (n8n-nodes-base.stickyNote)
Provides a visual marker with the label `# Logo` indicating section content related to logo or branding visuals; no direct data processing.

---

### Postgres (n8n-nodes-base.postgres - Postgres5)
Performs a query on the `clickup_folders`, `clickup_lists`, and `tasks` tables to retrieve folder and list info for a given task ID.

- Query:
  ```sql
  SELECT
  cf.name,
  cf.account
  FROM public.clickup_folders cf
  JOIN public.clickup_lists cl on cl.folder = cf.id
  JOIN public.tasks t ON t.list_id = cl.id
  WHERE t.task_id = '{{ $json.query.id }}'
  ```
- Credentials: `SquadData - N. Cal Replica`
- Operation: `executeQuery`

---

### Switch (Switch2)
Branches execution based on conditions involving the presence of a task `id` and `account` parameter in the query.

- Rules:
  - If `query.id` exists and `query.account` does not, follow the first branch.
  - If `query.id` does not exist and `query.account` exists, follow the second branch.
- Fallback output: `extra`

---

### Get Account1 (n8n-nodes-base.set)
Assigns the account number from the query parameters to the output data.

- Assign: `account = {{ $json.query.account }}`

---

### Respond to Webhook (n8n-nodes-base.respondToWebhook)
Returns a 400 response with a message about conflicting parameters if both account and task ID are supplied at the same time.

- Response Code: 400
- Response Body: `"Only one of account or task ID params can be supplied at a time."`

---

### Webhook (n8n-nodes-base.webhook)
Secondary webhook for `/play-pause` POST requests, configured to handle PATCH methods.

---

### ClickUp (n8n-nodes-base.clickUp)
Updates specific task fields in ClickUp, e.g., setting status to `on hold` based on the task ID.

- Operation: `update`
- Update Fields: `status: "on hold"`
- Credentials: `TheSquad API`

---

### Switch (Switch4)
Branches the flow based on `action` (`pause` or `play`) from the payload.

- Rules:
  - If `action` equals `"pause"`, output to `pause`.
  - If `action` equals `"play"`, output to `play`.

---

### Edit Fields (n8n-nodes-base.set - Edit Fields9)
Sets parameters for task update, including task ID, `status` as `"on hold"`, and `active: false`.

- Assignments:
  - `task_id = {{ $json.id }}`
  - `status = "on hold"`
  - `active = false`

---

### Postgres (Postgres7)
Retrieves the latest status of a task from `status_history` table.

- Query:
  ```sql
  WITH latest_status AS (
      SELECT DISTINCT ON (task_id) task_id, status_after, changed_at
      FROM public.status_history
      ORDER BY task_id, changed_at DESC
  )
  SELECT * FROM latest_status WHERE task_id = '{{ $json.task_id }}'
  ```

---

### Edit Fields (Edit Fields12)
Sets task fields for `on hold` state in further processing, including due date.

- Assignments:
  - `task_id = {{ $json.id }}`
  - `status = {{ $json.status_before }}`
  - `active = true`
  - `due_date = {{ $json.due_date.toDateTime('ms').format('yyyy-MM-dd') }}`

---

### Webhook (Respond to Webhook)
Responds with a JSON indicating no tasks found (`"tasks_found": false`) for certain conditions.

---

### Merge (Merge10)
Combines data streams using position-based merging for other conditional flows.

---

### Conditional Branch: If2
Checks if a task ID exists for further specialized processing.

---

### ClickUp (ClickUp4)
Restores previous task status in ClickUp using the prior status information.

- Operation: `update`
- Fields:
  - `status: {{ $json.status_before }}`

---

### Postgres (Postgres18)
Inserts or updates data in `mmq_log` to log the play action, associating with folder A number.

- Data:
  ```json
  {
    "input": "{{ $('Switch5').item.json.body.toJsonString() }}",
    "clickup": {{ $('Merge9').item.json.toJsonString() }}
  }
  ```
- Operation: `executeQuery`
- Query:
  ```sql
  INSERT INTO mmq_log (data, action, account)
  VALUES (
    {{ $json.data }},
    "play",
    {{ $json.folder.name.match(/\\d+/)[0] > 0 ? $json.folder.name.match(/\\d+/)[0] : ($json.list.name.match(/\\d+/)[0] > 0 ? $json.list.name.match(/\\d+/)[0] : null) }}
  )
  ```

---

### Webhook (Respond to Webhook)
Confirms processing status for either paused or played task actions.

---

### Postgres (Postgres14)
Creates or updates a activity log to log task changes happening in the system, referencing related data such as task, account, and the latest event.

- Query:
  (Complex WITH statements involving status, due date, assignee, and tags to determine current task state and assign updates accordingly.)

---

### Merge (Merge9)
Merges multiple data streams related to task updates to analyze combined information.

---

### Conditional: If
Checks for presence of `due_date_after` to determine next steps such as setting task aside or process continuation.

---

### ClickUp (ClickUp4)
Restores task status in ClickUp, setting it back from `on hold`.

---

### Postgres (Postgres18)
Logs the play action in `mmq_log` with associated details, similar as above but for pause actions.

---

## Summary

This workflow provides a robust real-time task management system triggered by PATCH webhooks at `/mmq`. It performs key database lookups related to task statuses, handling the queuing system logic, such as marking tasks on hold or resuming play. It updates necessary task data in ClickUp, logs activity, and manages task limits based on account capacity. Conditional branching and real-time webhooks allow for flexible task state control, making this system suited for queue-driven task workflows with shared resource management.

---